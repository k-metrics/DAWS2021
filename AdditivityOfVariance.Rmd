---
title: "分散の加法性を視覚的に理解する"
runningheader: "分散の加法性を視覚的に理解する" # only for pdf output
# subtitle: "An implementation in R Markdown" # only for html output
author: "Sampo Suzuki, CC 4.0 BY-NC-SA"
date: "`r Sys.Date()`"
output:
  tufte::tufte_handout:
    includes:
      in_header: latex/preamble.tex # 必要なパッケージやフォントの設定
    citation_package: natbib
    latex_engine: xelatex
    fig_caption: yes
    keep_tex: yes
  tufte::tufte_html: default
  tufte::tufte_book:
    includes:
      in_header: latex/preamble.tex # 必要なパッケージやフォントの設定
    citation_package: natbib
    latex_engine: xelatex
    fig_caption: yes
    keep_tex: yes
always_allow_html: true  # 一種の呪文
bibliography: [bib/references.bib]
link-citations: true     # 参考文献一覧へのリンクを有効化
colorlinks: true         # ハイパーリンクを色分けする
fig_crop: false
# fontsize: 12pt         # 本文のフォントサイズ（tufteでは変更できない）
linestretch: 1.1         # 行間の指定
links-as-notes: true     # ハイパーリンク先を脚注に記載
mainfontoptions: "Scale=MatchUppercase"
monofontoptions: "Scale=0.8"      # 0.96がベストらしいが…
CJKoptions: "Scale=1.0"
---

```{r setup, include=FALSE}
library(tidyverse)
library(tufte)

# invalidate cache when the tufte version changes
knitr::opts_chunk$set(cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)

# tufte packageでは、余白に図などを表示させるためにfig.posによる固定表示はできません
knitr::opts_chunk$set(echo = TRUE,                 # Rコードを出力する
                      warning = FALSE,             # Rの警告を抑止する
                      fig_caption = TRUE,
                      fig.align = 'center',        # 図を中央揃えにする
                      attr.source='.numberLines'   # Rコードに行番号表示
                      )

if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(dev = "cairo_pdf",       # 図の出力にPDFデバイスを使う
                        dev.args = list(family = "Source Han Code JP"),
                                                 # 図のフォントを指定する
                        tinytex.verbose = TRUE   # デバッグ用メッセージを出力
                        )
}

n <- 5000000    # 5,000,000
```

# **Introduction**
　2021年度データ分析勉強会のテキストである『統計解析のはなし』[@ToukeiKaisekinoHanashi]の「標本が２つになれば」（P26〜）には分散の加法性の話が出てきます。分散の加法性は理解できるようでいて、理解できていないので、**R**を使って分散の加法性を可視化しながら説明してみます。

以降、平均値$\mu$、標準偏差$\sigma$、分散$\sigma^2$である正規分布を$N(\mu, \sigma^2)$と表記します。

　  

# **加法性を可視化する**
　以下の平均値と標準偏差を持つ二つの正規分布を`rnorm()`関数による正規分布乱数を用いて作成^[n = `r n`個の値を作成しています]します。ここでは処理の都合上、二つをデータフレームにまとめてあります。

: 二つの正規分布

正規分布               | 平均         | 標準偏差        | 備考
-----------------------|--------------|-----------------|------
$N(\mu_a, \sigma^2_a)$ | $\mu_a = 10$ | $\sigma_a = 10$ |
$N(\mu_b, \sigma^2_b)$ | $\mu_b = 30$ | $\sigma_b = 10$ |


```{r}
x <- data.frame(a = rnorm(n, mean = 10, sd = 10),
                b = rnorm(n, mean = 30, sd = 10))
```

```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_a, \\sigma^2_a)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_a, \\sigma^2_a)$の分布"}
x %>% 
  ggplot2::ggplot(ggplot2::aes(x = a)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(y = c(0, 0.05))
```


```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_b, \\sigma^2_bｂ)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_b, \\sigma^2_b)$の分布"}
x %>% 
  ggplot2::ggplot(ggplot2::aes(x = b)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(y = c(0, 0.05))
```


: 二つの正規分布の要約統計量

正規分布               | 平均          | 標準偏差        | 備考
-----------------------|:-------------:|:---------------:|------
$N(\mu_a, \sigma^2_a)$ | `r mean(x$a)` | `r sd(x$a)`     |
$N(\mu_b, \sigma^2_b)$ | `r mean(x$b)` | `r sd(x$b)`     |


この二つの正規分布$N(\mu_a, \sigma^2_a)$と$N(\mu_b,\sigma^2_b)$からランダムサンプリングにより一つずづ値を取り出して加算します。すなわち
　
$$N(\mu_a, \sigma^2_a)\mbox{ から取り出した値} + N(\mu_b,\sigma^2_b)\mbox{ から取り出した値}$$

という新しい値を作成します。取り出した値は元に戻し、同様の取り出し、加算を繰り返すと以下のようなデータが作成できます。ここではスペースの都合で先頭から限定して表示しています。

<!-- \newpage -->

```{r}
c <- c(sample(x$a, n, replace = TRUE) + sample(x$b, n, replace = TRUE))
head(c, 50)
```


分散の加法性により上記のデータは$N(\mu_a + \mu_b, \sigma^2_a + \sigma^2_b))$という正規分布になるはずですが実際はどうでしょう。各正規分布の平均値と分散を比較します。


正規分布               | 平均          | 分散            | 備考
-----------------------|:-------------:|:---------------:|------
$N(\mu_a, \sigma^2_a)$ | `r mean(x$a)` | `r var(x$a)`    | 元の分布
$N(\mu_b, \sigma^2_b)$ | `r mean(x$b)` | `r var(x$b)`    | 元の分布
$N(\mu_a + \mu_b, \sigma^2_a + \sigma^2_b))$ | `r mean(x$a) + mean(x$b)` | `r var(x$a) + var(x$b)` | 分散の加法性
$N(\mu_c, \sigma^2_c)$ | `r mean(c)`   | `r var(c)`      | 

このように確かに分散の加法性が成り立っており、正規分布$N(\mu_a, \sigma^2_a)$や$N(\mu_b,\sigma^2_b)$より横に広がった正規分布になっていることが分かります。

```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_c, \\sigma^2_c)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_c, \\sigma^2_c)$の分布"}
data.frame(c = c) %>% 
  ggplot2::ggplot(ggplot2::aes(x = c)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(y = c(0, 0.05))
```

\newpage

## **同一の正規分布から取り出し値を加算した場合**
　次に二つの正規分布$N(\mu_a, \sigma^2_a)$と$N(\mu_b,\sigma^2_b)$がまったく等しいと仮定します。つまり

$$\mu_a = \mu_b = \mu_d$$

$$\sigma_a = \sigma_b = \sigma_d$$

という正規分布$N(\mu_d, \sigma^2_d)$を作成します。

```{r}
d <- rnorm(n, mean = 10, sd = 10)
head(d, 50)
```


この正規分布$N(\mu_d, \sigma^2_d)$から先程と同様にランダムサンプリングにより一つずづ値を取り出して加算しますが、今回は同一正規分布$N(\mu_d, \sigma^2_d)$ですので、二つ取り出します。取り出した値は元の正規分布に戻し同様の操作を繰り返します。

　  

```{r}
e <- c(sample(d, n, replace = TRUE) + sample(d, n, replace = TRUE))
head(e, 50)
```

\newpage

分散の加法性により以下が成り立ちます。

$$N(\mu_d + \mu_d, \sigma^2_d + \sigma^2_d) = N(2\mu_d, 2\sigma^2_d)$$

つまり、正規分布$N(\mu_d, \sigma^2_d)$から取り出した二つの値の和である正規分布$N(\mu_e, \sigma^2_e)$は

正規分布 | 平均      | 分散      | 備考
---------|:---------:|:---------:|-----
$N(\mu_e, \sigma^2_e)$ | $2 \mu_d$ | $2 \sigma^2_d$ 

という正規分布をすることになります。加法性と実際の正規分布を比べてみると


正規分布       | 平均      | 分散      | 備考
---------------|:---------:|:---------:|------
$N(\mu_d, \sigma^2_d)$ | `r mean(d)` | `r var(d)`    | 元の分布
$N(2\mu_d, 2\sigma^2_d)$ | `r 2*mean(d)` | `r 2*var(d)` | 分散の加法性
$N(\mu_e, \sigma^2_e)$ | `r mean(e)` | `r var(e)`    | 


となり、同一正規分布の場合でも分散の加法性が成り立っていることが分かります。

```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_d, \\sigma^2_d)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_c, \\sigma^2_c)$の分布"}
data.frame(d = d) %>% 
  ggplot2::ggplot(ggplot2::aes(x = d)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(y = c(0, 0.05))
```


```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_e, \\sigma^2_e)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_c, \\sigma^2_c)$の分布"}
data.frame(e = e) %>% 
  ggplot2::ggplot(ggplot2::aes(x = e)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(y = c(0, 0.05))
```

\newpage

## **同一の正規分布から取り出した値を平均した場合**
　最後に同一の正規分布$N(\mu_d, \sigma^2_d)$から取り出した二つの値の**平均値の分布**を考えてみます。「二つの値の平均値の平均値」とは、正規分布$N(\mu_d, \sigma^2_d)$から、ランダムサンプリングで二つの値を取り出して、その平均値を取るということです。取り出した値は元の正規分布へ戻し、同様の操作を繰り返します。

```{r}
f <- c((sample(d, n, replace = TRUE) + sample(d, n, replace = TRUE)) / 2)
head(f, 20)
```

この正規分布正規分布$N(\mu_f, \sigma^2_f)$は、二つの値の平均値、つまり二つの値を半分に割った値ですので正規分布$N(2\mu_d, 2\sigma^2_d)$のすべての値を半分にした正規分布になると予想できます。

$$\mbox{「二つの標本の平均値」の平均値} = \frac{2\mu_d}{2} = \mu_d$$


$$\mbox{「二つの標本の平均値」の標準偏差} = \sqrt{\frac{2\sigma^2_d}{2}} = \frac{\sigma_d}{\sqrt{2}}$$

$$\mbox{「二つの標本の平均値」の分散} = (\frac{\sigma_d}{\sqrt{2}})^2 = \frac{\sigma^2_d}{2}$$


```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_d, \\sigma^2_d)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_c, \\sigma^2_c)$の分布"}
data.frame(d = d) %>% 
  ggplot2::ggplot(ggplot2::aes(x = d)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(x = c(-30, 60), y = c(0, 0.07))
```

```{r, fig.margin = TRUE, fig.cap = "$N(\\mu_f, \\sigma^2_f)$の分布", fig.width=3.5, fig.height=3.5, echo=FALSE, message=FALSE}
# ```{r, echo=FALSE, message=FALSE, fig.cap="$N(\\mu_c, \\sigma^2_c)$の分布"}
data.frame(f = f) %>% 
  ggplot2::ggplot(ggplot2::aes(x = f)) + 
  # ggplot2::geom_histogram() + 
  ggplot2::geom_density() +
  # ggplot2::theme(axis.text.y = element_blank()) + 
  ggplot2::labs(x = "", y = "") + ggplot2::lims(x = c(-30, 60), y = c(0, 0.07))
```

正規分布       | 平均      | 分散      | 標準偏差  | 備考
---------------|:---------:|:---------:|:---------:|------
$N(\mu_d, \sigma^2_d)$ | `r mean(d)` | `r var(d)`  | `r sd(d)` | 元の分布
$N(\mu_d, \frac{\sigma^2_d)}{2}$ | `r mean(d)` | `r var(d) / 2`  | `r sd(d) / sqrt(2)` | 分散の加法性
$N(\mu_f, \sigma^2_f)$ | `r mean(f)` | `r var(f)`  | `r sd(f)` |

このように元の分布よりも鋭い分布になっていることがわかります。

\newpage

# **About handout style**
The Tufte handout style is a style that Edward Tufte uses in his books and handouts. Tufte's style is known for its extensive use of sidenotes, tight integration of graphics with text, and well-set typography. This style has been implemented in LaTeX and HTML/CSS^[See Github repositories [tufte-latex](https://github.com/tufte-latex/tufte-latex) and [tufte-css](https://github.com/edwardtufte/tufte-css)], respectively.

　  

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
